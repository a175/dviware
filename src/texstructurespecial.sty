%\usepackage[T1]{fontenc}
%\usepackage{lmodern}
%\usepackage{textcomp}
%\usepackage{unicode-math}
\RequirePackage{everyhook}
%\RequirePackage{amsmath}

\newif\if@nu@in@ams@display@math@
\@nu@in@ams@display@math@false

\ifdefined\align
\renewenvironment{align}{%
  \nu@xxx@BeginDisplay%
  \@nu@in@ams@display@math@true%
  \start@align\@ne\st@rredfalse\m@ne%
  \@nu@in@ams@display@math@false%
}{%
  \math@cr \black@\totwidth@
  \egroup
  \ifingather@
    \restorealignstate@
    \egroup
    \nonumber
    \ifnum0=`{\fi\iffalse}\fi
  \else
    $$%
  \fi
  \ignorespacesafterend
}
\renewenvironment{align*}{%
  \nu@xxx@BeginDisplay%
  \@nu@in@ams@display@math@true%
  \start@align\@ne\st@rredtrue\m@ne
  \@nu@in@ams@display@math@false%
}{%
  \endalign
}
\renewenvironment{gather}{%
  \nu@xxx@BeginDisplay%
  \@nu@in@ams@display@math@true%
  \start@gather\st@rredfalse%
  \@nu@in@ams@display@math@false%
}{%
  \math@cr \black@\totwidth@ \egroup
  $$\ignorespacesafterend
}

\renewenvironment{gather*}{%
  \nu@xxx@BeginDisplay%
  \@nu@in@ams@display@math@true%
  \start@gather\st@rredtrue%
  \@nu@in@ams@display@math@false%
}{%
  \endgather
}

\renewenvironment{alignat}{%
  \nu@xxx@BeginDisplay%
  \@nu@in@ams@display@math@true%
  \start@align\z@\st@rredfalse
  \@nu@in@ams@display@math@false%
}{%
  \endalign
}
\renewenvironment{alignat*}{%
  \nu@xxx@BeginDisplay%
  \@nu@in@ams@display@math@true%
  \start@align\z@\st@rredtrue
  \@nu@in@ams@display@math@false%
}{%
  \endalign
}
\renewenvironment{xalignat}{%
  \nu@xxx@BeginDisplay%
  \@nu@in@ams@display@math@true%
  \start@align\@ne\st@rredfalse
  \@nu@in@ams@display@math@false%
}{%
  \endalign
}
\renewenvironment{xalignat*}{%
  \nu@xxx@BeginDisplay%
  \@nu@in@ams@display@math@true%
  \start@align\@ne\st@rredtrue
  \@nu@in@ams@display@math@false%
}{%
  \endalign
}
\renewenvironment{xxalignat}{%
  \nu@xxx@BeginDisplay%
  \@nu@in@ams@display@math@true%
  \start@align\tw@\st@rredtrue
  \@nu@in@ams@display@math@false%
}{%
  \endalign
}
\renewenvironment{flalign}{%
  \nu@xxx@BeginDisplay%
  \@nu@in@ams@display@math@true%
  \start@align\tw@\st@rredfalse\m@ne
  \@nu@in@ams@display@math@false%
}{%
  \endalign
}
\renewenvironment{flalign*}{%
  \nu@xxx@BeginDisplay%
  \@nu@in@ams@display@math@true%
  \start@align\tw@\st@rredtrue\m@ne
  \@nu@in@ams@display@math@false%
}{%
  \endalign
}
\renewenvironment{multline}{%
  \nu@xxx@BeginDisplay%
  \@nu@in@ams@display@math@true%
  \start@multline\st@rredfalse
  \@nu@in@ams@display@math@false%
}{%
  \iftagsleft@ \@xp\lendmultline@ \else \@xp\rendmultline@ \fi
  \ignorespacesafterend
}
\renewenvironment{multline*}{%
    \nu@xxx@BeginDisplay%
  \@nu@in@ams@display@math@true%
  \start@multline\st@rredtrue%
  \@nu@in@ams@display@math@false%
}{\endmultline}

\fi

\newcommand{\nu@xxx@BeginMath}{\special{texstructure:begin_math}}
\newcommand{\nu@xxx@EndMath}{\special{texstructure:end_math}}
\newcommand{\nu@xxx@BeginDisplay}{\special{texstructure:begin_display}}
\newcommand{\nu@xxx@EndDisplay}{\special{texstructure:end_display}}
\newcommand{\nu@xxx@par}[1]{\special{texstructure:start_par:parindent=#1}}
\newcommand{\nu@xxx@Begin@list}{\special{texstructure:begin_list}}
\newcommand{\nu@xxx@End@list}{\special{texstructure:end_list}}
\newcommand{\nu@xxx@Begin@trivlist}{\special{texstructure:begin_trivlist}}
\newcommand{\nu@xxx@End@trivlist}{\special{texstructure:end_trivlist}}
\newcommand{\nu@xxx@item}{\special{texstructure:item}}
\PushPostHook{math}{\nu@xxx@BeginMath\aftergroup\nu@xxx@EndMath}
\PushPostHook{display}{\if@nu@in@ams@display@math@\else\nu@xxx@BeginDisplay\fi\aftergroup\nu@xxx@EndDisplay}
\PushPostHook{par}{\nu@xxx@par{\the\parindent}}


\let\nu@old@list\list
\renewcommand{\list}{\nu@xxx@Begin@list\aftergroup\nu@xxx@End@list\nu@old@list}
\let\nu@old@item\item
\renewcommand{\item}{\nu@xxx@item\nu@old@item}
\let\nu@old@trivlist\trivlist
\renewcommand{\trivlist}{\nu@xxx@Begin@trivlist\aftergroup\nu@xxx@End@trivlist\nu@old@trivlist}

\ifdefined\section
\newcommand{\nu@xxx@new@section}{\special{texstructure:start_section}}
\let\nu@old@section\section
\renewcommand{\section}{\nu@xxx@new@section\nu@old@section}
\fi
\ifdefined\subsection
\newcommand{\nu@xxx@new@subsection}{\special{texstructure:start_subsection}}
\let\nu@old@subsection\subsection
\renewcommand{\subsection}{\nu@xxx@new@subsection\nu@old@subsection}
\fi
\ifdefined\subsubsection
\newcommand{\nu@xxx@new@subsubsection}{\special{texstructure:start_subsubsection}}
\let\nu@old@subsubsection\subsubsection
\renewcommand{\subsubsection}{\nu@xxx@new@subsubsection\nu@old@subsubsection}
\fi


\newcommand\indentedraggedright{%
  \let\\\@centercr\@rightskip\@flushglue \rightskip\@rightskip
  \leftskip\z@skip}
